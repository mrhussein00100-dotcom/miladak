import { AgeData } from "@/types";
import { formatNumber } from "@/lib/ageCalculations";

type MsgCtx = {
  y: number; m: number; d: number;
  yN: string; mN: string; dN: string;
  days: string; until: string;
};

export type AgeTone =
  | "newborn"     // 0-59 days
  | "infant"      // 2-11 months
  | "toddler"     // 1-4 years
  | "kid"         // 5-12 years
  | "teen"        // 13-17 years
  | "young"       // 18-29 years
  | "adult"       // 30-44 years
  | "mature"      // 45-59 years
  | "senior"      // 60-74 years
  | "elder";      // 75+

export interface AgeMessage {
  tone: AgeTone;
  title: string;
  lines: string[];
}

// Generate additional per-year templates to deepen variety across all ages
function buildYearBank(y: number): ((c: MsgCtx) => string)[] {
  return [
    // 1-4 toddler nuanced
    ...(y >= 1 && y <= 4 ? [
      ({ yN }: MsgCtx) => `عام ${yN} — اللعب الحرّ بإشراف يطوّر التوازن والخيال.`,
      ({ yN }: MsgCtx) => `في عام ${yN} — قصص قصيرة وتسمية الأشياء تعزّز اللغة.`,
    ] : []),
    // 5-9 primary
    ...(y >= 5 && y <= 9 ? [
      ({ yN }: MsgCtx) => `عام ${yN} — قراءة يومية 10 دقائق تبني عادة معرفية.`,
      ({ yN }: MsgCtx) => `في عام ${yN} — نشاط بدني لطيف يثبّت الطاقة والتركّز.`,
    ] : []),
    // 10-12 pre-teen
    ...(y >= 10 && y <= 12 ? [
      ({ yN }: MsgCtx) => `عمر ${yN} — أهداف أسبوعية واضحة تعلّم الالتزام.`,
      ({ yN }: MsgCtx) => `عام ${yN} — هواية ممتعة تصنع ثقة ومسؤولية.`,
    ] : []),
    // 13-17 teen
    ...(y >= 13 && y <= 17 ? [
      ({ yN }: MsgCtx) => `عمر ${yN} — إدارة الوقت ترفع النتائج الدراسية والحياتية.`,
      ({ yN }: MsgCtx) => `عام ${yN} — جرّب وتعلّم بأمان؛ التجارب الصغيرة توسّع آفاقك.`,
    ] : []),
    // 18-21 launch
    ...(y >= 18 && y <= 21 ? [
      ({ yN }: MsgCtx) => `عمر ${yN} — مهارة قابلة للتوظيف + عادة صحية = انطلاقة موفّقة.`,
      ({ yN }: MsgCtx) => `عام ${yN} — شبكة علاقات محترمة تفتح أبوابًا كثيرة.`,
    ] : []),
    // 22-29 young
    ...(y >= 22 && y <= 29 ? [
      ({ yN }: MsgCtx) => `عمر ${yN} — ساعة يومية لمهارة مركّزة تغيّر سنوات قادمة.`,
      ({ yN }: MsgCtx) => `عام ${yN} — خطّة شهرية بسيطة تحافظ على الاتساق.`,
    ] : []),
    // 30-34 adult early
    ...(y >= 30 && y <= 34 ? [
      ({ yN }: MsgCtx) => `عمر ${yN} — توازن أولوياتك يساوي جودة أعلى ليومك.`,
      ({ yN }: MsgCtx) => `عام ${yN} — صيانة العادات أهم من زيادتها.`,
    ] : []),
    // 35-39
    ...(y >= 35 && y <= 39 ? [
      ({ yN }: MsgCtx) => `عمر ${yN} — راجع الاتجاه: ما الذي يستحق الاستمرار؟`,
      ({ yN }: MsgCtx) => `عام ${yN} — نوم منتظم ونشاط ثابت يصنعان فرقًا ملموسًا.`,
    ] : []),
    // 40-44
    ...(y >= 40 && y <= 44 ? [
      ({ yN }: MsgCtx) => `عمر ${yN} — اتزان العلاقات والعمل يمنح راحة أعمق.`,
      ({ yN }: MsgCtx) => `عام ${yN} — متابعة صحية منتظمة واستثمار بالعلاقات القريبة.`,
    ] : []),
    // 45-49
    ...(y >= 45 && y <= 49 ? [
      ({ yN }: MsgCtx) => `عمر ${yN} — خبرتك قيمة: شاركها بذكاء.`,
      ({ yN }: MsgCtx) => `عام ${yN} — نشاط معتدل وفحوصات أساسية بانتظام.`,
    ] : []),
    // 50-54
    ...(y >= 50 && y <= 54 ? [
      ({ yN }: MsgCtx) => `عمر ${yN} — وتيرة أهدأ واهتمام بالصحة النوعية.`,
      ({ yN }: MsgCtx) => `عام ${yN} — وقت للعائلة والهوايات يعيد التوازن.`,
    ] : []),
    // 55-59
    ...(y >= 55 && y <= 59 ? [
      ({ yN }: MsgCtx) => `عمر ${yN} — علاقات دافئة ونشاط منتظم ينعشان اليوم.`,
      ({ yN }: MsgCtx) => `عام ${yN} — تغذية واعية وخطوات خفيفة يوميًا.`,
    ] : []),
    // 60-64
    ...(y >= 60 && y <= 64 ? [
      ({ yN }: MsgCtx) => `عمر ${yN} — نمط حياة لطيف وروابط اجتماعية داعمة.`,
      ({ yN }: MsgCtx) => `عام ${yN} — متابعة طبية روتينية وراحة كافية.`,
    ] : []),
    // 65-69
    ...(y >= 65 && y <= 69 ? [
      ({ yN }: MsgCtx) => `عمر ${yN} — حافظ على الحركة والبهجة بجرعات يومية.`,
      ({ yN }: MsgCtx) => `عام ${yN} — أنشطة اجتماعية ترفع المعنويات.`,
    ] : []),
    // 70-74
    ...(y >= 70 && y <= 74 ? [
      ({ yN }: MsgCtx) => `عمر ${yN} — بساطة اليوم وجودة النوم أولويات.`,
      ({ yN }: MsgCtx) => `عام ${yN} — مشي لطيف ولقاءات قريبة تمنح طاقة جميلة.`,
    ] : []),
    // 75-79
    ...(y >= 75 && y <= 79 ? [
      ({ yN }: MsgCtx) => `عمر ${yN} — خفّف الإيقاع واستمتع بالصحبة والذكريات.`,
      ({ yN }: MsgCtx) => `عام ${yN} — رعاية ذاتية رحيمة وتواصل دافئ.`,
    ] : []),
    // 80+
    ...(y >= 80 ? [
      ({ yN }: MsgCtx) => `عمر ${yN} — راحة وبهجة ولمّ شمل يكفيان.`,
      ({ yN }: MsgCtx) => `عام ${yN} — حافظ على نشاط بسيط وساعات نوم مستقرة.`,
    ] : []),
  ];
}

// Month-of-age specific: generate 20+ smart messages for 0–23 months
function buildAgeMonthBank(age: AgeData): ((c: MsgCtx) => string)[] {
  const totalMonths = age.years * 12 + age.months;
  if (totalMonths >= 24) return [];
  const m = totalMonths; // 0..23
  const MONTH_FOCUS_0_23: string[] = [
    "روتين نوم ولمس لطيف وتواصل بصري",
    "رفع الرأس ثوانٍ ونوم منظم",
    "تتبع بصري للأشياء وأصوات هادئة",
    "انقلاب خفيف وبسمة استجابة",
    "إمساك بسيط ولعب تفاعلي قصير",
    "تعرّف على القوام والجلوس بمساعدة",
    "جلسات قصيرة على البطن وحركات نحو اللعبة",
    "زحف أولي وبابابا/دادادا",
    "قبضة أدق وإشارات بسيطة",
    "وقوف بمساعدة ومحاولات كلمات",
    "خطوات بدعم وفهم إشارات",
    "كلمة/كلمتان وتقليد حركات",
    "المشي الأول واستكشاف آمن",
    "فضول عالٍ وحدود لطيفة",
    "كلمات أكثر وروتين واضح",
    "لعب تقليد وتعليم خطوة واحدة",
    "تنظيم نوم وقيلولة",
    "تركيب بسيط وتجارب قصيرة",
    "جملة من كلمتين ومحاولة تسمية",
    "حركات أدق ومهام صغيرة",
    "استقلال لطيف وخياران واضحان",
    "تعاون في اللبس وترتيب بسيط",
    "تسمية مشاعر بسيطة",
    "قصص قصيرة وتدرّب على المشاركة",
  ];
  const focus = MONTH_FOCUS_0_23[m] ?? "وتيرة لطيفة ومتابعة هادئة";

  const open = ({ m, d, mN, dN }: MsgCtx): string => {
    if (m <= 0) {
      if (d > 0) return `عمر ${dN} يومًا — ${focus}.`;
      return `اليوم الأول — ${focus}.`;
    }
    if (d <= 0) return `عمر ${mN} شهرًا — ${focus}.`;
    return `عمر ${mN} شهرًا و${dN} يومًا — ${focus}.`;
  };
  const DEV = [
    `جلسات بطن قصيرة تحت إشراف.`,
    `تواصل بصري وابتسامة لطيفة.`,
    `تسمية الأشياء بصوت هادئ.`,
    `إيماءات بسيطة مع الكلمات.`,
    `قراءة صورة واحدة ببطء.`,
  ];
  const ROUTINE = [
    `روتين نوم هادئ ومتكرر.`,
    `وتيرة لطيفة تناسب المرحلة.`,
    `راحة كافية بين المحاولات.`,
    `بيئة هادئة بإضاءة خافتة.`,
    `تنظيم بسيط لوقت الرضاعة.`,
  ];
  const PLAY = [
    `لعب تفاعلي قليل وهادئ.`,
    `أغانٍ قصيرة بإيقاع لطيف.`,
    `ألعاب ألوان وفرز بسيطة.`,
    `تكرار كلمات مع الإشارة.`,
    `إخفاء/ظهور بسيط (peek-a-boo).`,
  ];
  const SAFETY = [
    `مساحة لعب آمنة وخالية من المخاطر.`,
    `إبعاد القطع الصغيرة والحواف.`,
    `مراقبة دقيقة وقت الاستكشاف.`,
    `تثبيت الأشياء الثقيلة.`,
    `أرضية نظيفة وغير زلِقة.`,
  ];
  const BOND = [
    `حضن دافئ وملامسة مطمئنة.`,
    `قراءة قصيرة بنبرة هادئة.`,
    `حديث ناعم باسمه.`,
    `ابتسامة وتواصل عين-بعين.`,
    `روتين تهدئة قبل النوم.`,
  ];
  const CHECK = [
    `متابعة نمو وتطعيمات بموعدها.`,
    `سجّل ملاحظات صغيرة عن التقدّم.`,
    `استفسر عند أي قلق بهدوء.`,
    `وَثّق محاولات جديدة بصور.`,
    `استمرار على ما ينجح بلطف.`,
  ];
  const METRICS = [
    `٥–١٠ دقائق تكفي.`,
    `مرتان يوميًا حسب الاستجابة.`,
    `٣ تكرارات قصيرة.`,
    `جلسة قصيرة بعد الغفوة.`,
    `خطوة واحدة كل مرة.`,
  ];

  const compose = (a: string, b: string, c: string) =>
    (ctx: MsgCtx) => `${open(ctx)} ${a} ${b} ${c}`;

  const arr: ((c: MsgCtx) => string)[] = [];
  // 20 توليفات على الأقل: DEV×ROUTINE×METRICS، PLAY×SAFETY×METRICS، BOND×ROUTINE×METRICS ...
  for (let i = 0; i < 4; i++) arr.push(compose(DEV[i], ROUTINE[i], METRICS[i]));
  for (let i = 0; i < 4; i++) arr.push(compose(PLAY[i], SAFETY[i], METRICS[(i+1)%METRICS.length]));
  for (let i = 0; i < 4; i++) arr.push(compose(BOND[i], ROUTINE[(i+2)%ROUTINE.length], METRICS[(i+2)%METRICS.length]));
  for (let i = 0; i < 4; i++) arr.push(compose(DEV[(i+1)%DEV.length], SAFETY[(i+1)%SAFETY.length], METRICS[(i+3)%METRICS.length]));
  for (let i = 0; i < 4; i++) arr.push(compose(PLAY[(i+2)%PLAY.length], CHECK[(i+2)%CHECK.length], METRICS[(i+4)%METRICS.length]));
  // ضمان تنويع الافتتاحية لبعض الرسائل
  arr.push((ctx: MsgCtx) => `${open(ctx)} ${DEV[4]} ${ROUTINE[4]} ${METRICS[0]}`);
  arr.push((ctx: MsgCtx) => `${open(ctx)} ${BOND[4]} ${SAFETY[3]} ${METRICS[1]}`);

  return arr;
}

// Curated messages for every single year 0–80 (3 per year), stage-appropriate.
const YEAR_FOCUS: Record<number, string> = {
  1: "تسمية الأشياء والروتين الهادئ",
  2: "الألوان والأشكال واللعب الحرّ",
  3: "الجمل القصيرة والخيال الموجّه",
  4: "الاستقلال اللطيف والمهارات اليومية",
  5: "القراءة المشتركة وحبّ الحروف",
  6: "الأرقام والجمع البسيط",
  7: "قصص أطول وفهم المعاني",
  8: "كتابة جمل بسيطة",
  9: "تجارب علمية آمنة",
  10: "جدول أسبوعي مصغّر",
  11: "زيارة المكتبة أو نادٍ مدرسي",
  12: "تهيئة للمراهقة: نوم ودراسة واضحة",
  13: "حدود واضحة ومسؤوليات خفيفة",
  14: "هواية منتظمة تُبنى",
  15: "مهارة قابلة للنمو",
  16: "إدارة الوقت ومشاريع قصيرة",
  17: "التخطيط للخطوة القادمة",
  18: "مهارة سوقية وبدايات العمل",
  19: "خبرة تطوعية وسيرة مبكرة",
  20: "شبكة علاقات محترمة",
  21: "استقلال مالي بسيط",
  22: "تعميق المهارة الأساسية",
  23: "تعلّم متقدم ومشاريع صغيرة",
  24: "توازن الصحة والعمل",
  25: "أهداف ربع سنوية واضحة",
  26: "مشروع جانبي متّسق",
  27: "تحسين السيرة والملف المهني",
  28: "بناء حضور مهني",
  29: "إعادة ضبط الاتجاه",
  30: "صيانة العادات",
  31: "فحص سنوي مالي وصحي",
  32: "مهارة قيادية",
  33: "تنظيم متقدّم للوقت",
  34: "تعميق العلاقات عالية الجودة",
  35: "مراجعة المسار",
  36: "جودة النوم والرياضة",
  37: "التركيز على الأهم",
  38: "مرونة عملية واعية",
  39: "استدامة العادات",
  40: "متابعة صحية منتظمة",
  41: "توازن العلاقات",
  42: "نمط حياة متزن",
  43: "إدخار واستثمار واعٍ",
  44: "فحوصات وقائية",
  45: "مشاركة الخبرة",
  46: "الإرشاد والتوجيه",
  47: "توازن العمل والأسرة",
  48: "رعاية ذاتية واعية",
  49: "تخطيط للمستقبل القريب",
  50: "وتيرة أهدأ ووقت للعائلة",
  51: "هوايات عميقة ممتعة",
  52: "علاقات دافئة مستمرة",
  53: "صحة نوعية مركّزة",
  54: "رحلات قصيرة منعشة",
  55: "نشاط لطيف منتظم",
  56: "تغذية واعية وثابتة",
  57: "صحبة قريبة داعمة",
  58: "مراجعات صحية دورية",
  59: "بساطة اليوم وراحة كافية",
  60: "نمط لطيف وروابط اجتماعية",
  61: "مشي خفيف يومي",
  62: "نوم منتظم",
  63: "مهام بسيطة ممتعة",
  64: "لقاءات عائلية دافئة",
  65: "حركة يومية مناسبة",
  66: "بهجة صغيرة يومية",
  67: "تواصل مع الأصدقاء",
  68: "أنشطة اجتماعية لطيفة",
  69: "استرخاء واعٍ",
  70: "بساطة وجودة نوم",
  71: "تواصل قريب مطمئن",
  72: "مشي صباحي لطيف",
  73: "هواية هادئة",
  74: "روتين مريح",
  75: "إبطاء الإيقاع",
  76: "ذكريات ودفء",
  77: "راحة رحيمة",
  78: "دعم اجتماعي لطيف",
  79: "تواصل عائلي وثيق",
  80: "لمّ شمل وراحة",
};

function curatedYearBank(y: number): ((c: MsgCtx) => string)[] {
  // تحت السنة الأولى نتعامل عبر underOne في مكان آخر
  if (y === 0) {
    return [
      ({ m, d, mN, dN }: MsgCtx) => (m > 0
        ? `عمر ${mN} شهرًا و${dN} يومًا — نوم منتظم وتغذية متوازنة يدعمان نموك.`
        : `اليوم ${dN} — الراحة والرعاية اللطيفة هي الأولوية الآن.`),
      ({ m, mN }: MsgCtx) => (m > 0
        ? `عمر ${mN} شهرًا — المتابعة الدورية تمنح طمأنينة ونموًا مطمئنًا.`
        : `أيامك الأولى — روتين هادئ وساعات نوم كافية.`),
      ({ d, dN }: MsgCtx) => (d > 0
        ? `اليوم ${dN} — وتيرة لطيفة وهدوء يساعدان على النمو السليم.`
        : `بدايات مطمئنة — الرعاية الدافئة تكفي الآن.`),
    ];
  }

  const focus = YEAR_FOCUS[y];
  if (!focus) {
    // احتياطي: توليد رسائل عامة لكن فريدة بذكر السنة
    return [
      ({ yN }: MsgCtx) => `عام ${yN} — اجعل يومك أبسط وأكثر اتزانًا.`,
      ({ yN }: MsgCtx) => `في عام ${yN} — خطة قصيرة وواضحة تكفي للثبات.`,
      ({ yN }: MsgCtx) => `عام ${yN} — استمرارية لطيفة تصنع تقدمًا هادئًا.`,
    ];
  }
  const stage: AgeTone = ((): AgeTone => {
    if (y === 0) return "infant";
    if (y >= 1 && y < 5) return "toddler";
    if (y < 13) return "kid";
    if (y < 18) return "teen";
    if (y < 30) return "young";
    if (y < 45) return "adult";
    if (y < 60) return "mature";
    if (y < 75) return "senior";
    return "elder";
  })();

  const CLOSERS: Record<AgeTone, (() => string)[]> = {
    newborn: [
      () => `النوم والهدوء أولوية الآن.`,
      () => `روتين لطيف يكفي حاليًا.`,
      () => `رعاية دافئة وتنظيم بسيط.`,
    ],
    infant: [
      () => `نوم منتظم وتغذية متوازنة.`,
      () => `روتين ثابت يبعث الطمأنينة.`,
      () => `هدوء ولطف في كل يوم.`,
    ],
    toddler: [
      () => `وقت قصة قبل النوم يكفي.`,
      () => `اللعب التفاعلي يبني اللغة.`,
      () => `روتين نوم هادئ يريح الجميع.`,
      () => `شجّع كلمات جديدة يوميًا.`,
      () => `لحظات حضن ودفء مهمة.`,
      () => `أسئلة مفتوحة قصيرة تثير الفضول.`,
      () => `سمِّ الأفعال أثناء اللعب.`,
    ],
    kid: [
      () => `الاستمرار أهم من الكمال.`,
      () => `امتدح الجهد لا النتيجة.`,
      () => `كتاب ممتع يفتح الشهية.`,
      () => `وقت شاشة متوازن.`,
      () => `قراءة مشتركة تعزز الحب.`,
      () => `ملصق إنجاز أسبوعي.`,
      () => `قراءة مع تعبيرات صوتية.`,
      () => `اسأل: ماذا تعلّمت اليوم؟`,
    ],
    teen: [
      () => `قسّم الهدف إلى أسابيع.`,
      () => `تابع تقدّمك كل جمعة.`,
      () => `وازن دراسة وراحة.`,
      () => `اختر رفيق دراسة.`,
      () => `حافظ على نوم كافٍ.`,
      () => `أغلق الهاتف أثناء الدراسة.`,
      () => `مشروع صغير يوضح تعلمك.`,
    ],
    young: [
      () => `ساعة مهارة تصنع فرقًا.`,
      () => `شبكة علاقات محترمة.`,
      () => `نوم منتظم يمنح طاقة.`,
      () => `مذكرة إنجازات شهرية.`,
      () => `طبّق ما تتعلمه فورًا.`,
      () => `قلّل المشتتات 30 دقيقة.`,
      () => `راجع مخرجات الأسبوع مساء الجمعة.`,
      () => `نم مبكرًا لفعالية أعلى.`,
    ],
    adult: [
      () => `توازن العمل والحياة.`,
      () => `صيانة العادات أهم.`,
      () => `فحص سنوي مطمئن.`,
      () => `استثمر في العلاقات.`,
      () => `خطة ربع سنوية واضحة.`,
      () => `ساعة تركيز بلا إشعارات.`,
      () => `راجع الميزانية شهريًا.`,
      () => `وقت يومي هادئ بلا شاشات.`,
    ],
    mature: [
      () => `شارك خبرتك.`,
      () => `نشاط معتدل.`,
      () => `فحوصات أساسية.`,
      () => `راحة كافية.`,
      () => `علاقات دافئة.`,
      () => `تمارين مرونة خفيفة.`,
      () => `اشرب ماء كفاية.`,
      () => `وقت هواية مريح.`,
    ],
    senior: [
      () => `روابط اجتماعية لطيفة.`,
      () => `بساطة اليوم.`,
      () => `جودة نوم.`,
      () => `نشاط خفيف.`,
      () => `بهجة يومية.`,
      () => `تواصل مع جار ودود.`,
      () => `شمس صباحية لطيفة.`,
      () => `موسيقى خفيفة.`,
    ],
    elder: [
      () => `راحة ولمّ شمل.`,
      () => `وتيرة لطيفة.`,
      () => `ذكريات دافئة.`,
      () => `صحبة قريبة.`,
      () => `طمأنينة يومية.`,
      () => `صورة عائلية اليوم.`,
      () => `دعاء بعد الفجر.`,
      () => `رسالة ودّية لأحد الأحبة.`,
    ],
  };

  const HINTS: Record<AgeTone, (() => string)[]> = {
    newborn: [() => `روتين هادئ.`],
    infant: [() => `متابعة دورية بلطف.`],
    toddler: [
      () => `سمّ الأشياء من حوله.`,
      () => `أشر واسأل سؤالًا بسيطًا.`,
      () => `كرّر الكلمات مع الإيماءات.`,
      () => `ألعاب فرز وألوان بسيطة.`,
      () => `غناء قصير بإيقاع لطيف.`,
      () => `وَصِف ما تفعل أمامه.`,
      () => `انطق ببطء ووضوح.`,
    ],
    kid: [
      () => `خطة واجبات بسيطة.`,
      () => `دفتر ملاحظات صغير.`,
      () => `قراءة 10 دقائق.`,
      () => `نشاط بدني خفيف.`,
      () => `سؤال يومي للاكتشاف.`,
      () => `لوح تتبع ملون.`,
      () => `اختيار كتاب بالاشتراك معه.`,
    ],
    teen: [
      () => `بطاقات مراجعة.`,
      () => `جلسات مركزة 25 دقيقة.`,
      () => `تثبيت أوقات الدراسة.`,
      () => `تمارين قصيرة للتركيز.`,
      () => `هدف أسبوعي واضح.`,
      () => `تقليل المشتتات الرقمية.`,
      () => `استخدام مؤقت الدراسة.`,
    ],
    young: [
      () => `مشروع صغير قابل للعرض.`,
      () => `سجلّ تقدم أسبوعي.`,
      () => `تقويم عادات.`,
      () => `تقليل المشتتات.`,
      () => `حزمة مهارات سوقية.`,
      () => `ملف إنجازات بسيط.`,
      () => `مؤشرات أداء شخصية.`,
    ],
    adult: [
      () => `تحديد أولويات.`,
      () => `قوائم مهام قصيرة.`,
      () => `جلسة تخطيط أسبوعية.`,
      () => `روتين صباحي بسيط.`,
      () => `نوم ٧–٨ ساعات.`,
      () => `استراحة دون شاشة.`,
      () => `حدّ وقت التواصل.`,
    ],
    mature: [
      () => `إرشاد الأصغر سنًا.`,
      () => `جداول خفيفة.`,
      () => `غذاء متوازن.`,
      () => `مشي لطيف.`,
      () => `نوم منتظم.`,
      () => `فيتامين علاقات أسبوعي.`,
      () => `تطوع بسيط.`,
    ],
    senior: [
      () => `تمارين توازن.`,
      () => `تنفس هادئ.`,
      () => `مشي قصير.`,
      () => `ألعاب ذهنية.`,
      () => `شاي مع صديق.`,
      () => `تمارين مرونة خفيفة.`,
      () => `تواصل مع مجموعة صغيرة.`,
    ],
    elder: [
      () => `موسيقى هادئة.`,
      () => `صورة قديمة.`,
      () => `حكاية قصيرة.`,
      () => `دعاء قصير.`,
      () => `ابتسامة دافئة.`,
      () => `تهوية الغرفة صباحًا.`,
      () => `شمس خفيفة قرب النافذة.`,
    ],
  };

  const SCHEDULES: Record<AgeTone, string[]> = {
    newborn: ["روتين لطيف"],
    infant: ["روتين نوم منتظم"],
    toddler: ["دقائق قصص يومية", "روتين نوم ثابت", "لعب حر بإشراف", "جولة قصيرة نهارية", "وقت سؤال قبل النوم"],
    kid: ["روتين واجبات بعد العصر", "قراءة قبل النوم", "نشاط بدني يومي", "مراجعة أسبوعية قصيرة", "لوح إنجازات"],
    teen: ["خطة أسبوعية", "جلسة يومية مركزة", "استراحة محسوبة", "مراجعة ليلية خفيفة", "صباح بلا مشتتات"],
    young: ["جلسة تعلم يومية", "هدف شهري", "خطة أسبوعية بسيطة", "وقفة مراجعة", "موعد مهارة ثابت"],
    adult: ["خطة أسبوعية", "هدف شهري", "مراجعة ربع سنوية", "بودجيت بسيط", "ساعة عميقة بلا إشعارات"],
    mature: ["مراجعة صحية دورية", "جلسة قراءة", "مشي يومي", "لقاء عائلي", "مكالمة صديق"],
    senior: ["روتين صباحي لطيف", "مشي قبل الغروب", "لقاءات قريبة", "قيلولة خفيفة", "جلسة هواية"],
    elder: ["جلسة صباحية هادئة", "مكالمة عائلية", "زيارة قصيرة", "قيلولة لطيفة", "جلسة صور قديمة"],
  };

  const ACTIONS: Record<AgeTone, string[]> = {
    newborn: ["رعاية لطيفة"],
    infant: ["تنظيم أوقات الرضاعة"],
    toddler: ["اقرأ قصة مصورة", "سمّ ثلاثة أشياء جديدة", "لعبة تركيب بسيطة", "نشاط حركي لطيف", "اصنع أغنية قصيرة", "العب لعبة تقمّص أدوار"],
    kid: ["اختر كتابًا شيقًا", "اكتب خمسة أسطر", "امشِ 15 دقيقة", "العب لعبة تعليمية", "ارسم فكرة اليوم", "ألّف حكاية قصيرة"],
    teen: ["اكتب أهداف اليوم", "راجع ملخص الدرس", "حل 5 مسائل", "اقرأ 10 صفحات", "درّب على امتحان قصير", "لخّص بفيديو دقيقتين"],
    young: ["طبّق بفيديو/عرض", "انشر ملخصًا", "جرّب في مشروع حقيقي", "اطلب تعقيبًا", "شارك في جلسة هاكاثون", "أجب على سؤال عام"],
    adult: ["احذف مهمة غير مهمة", "فوّض واحدة", "ركّز على أهم 1%", "راجع التقدم", "ساعة عميقة", "أغلق الإشعارات"],
    mature: ["اكتب خبرة", "ساعد شابًا", "اتصل بصديق", "زر قريبًا", "شارك مقالًا مفيدًا", "وثّق خبرة مهنية"],
    senior: ["اتصل بقريب", "اقرأ قصة", "اكتب ذكريات", "زر حديقة", "شارك في مجلس صغير", "اقطع 1000 خطوة"],
    elder: ["شارك ذكرى", "استمع لموسيقى", "شاهد ألبومًا", "تجوّل قليلًا", "اتصل بحبيب", "دوّن شكرًا قصيرًا"],
  };

  const METRICS: Record<AgeTone, string[]> = {
    newborn: ["ساعات نوم كافية"],
    infant: ["رضعات منتظمة"],
    toddler: ["٥ دقائق قراءة", "١٠ دقائق لعب", "مرتين يوميًا", "٣ تكرارات", "أغنية واحدة", "٣ صور مسمّاة"],
    kid: ["١٠ دقائق", "١٥ دقيقة", "٣ مرات أسبوعيًا", "٥ صفحات", "٢ ملصق إنجاز", "١ سؤال استكشافي"],
    teen: ["٢٥ دقيقة", "٣ مرات أسبوعيًا", "٥ مسائل", "١٠ صفحات", "جلسة واحدة بلا هاتف", "هدف واحد واضح"],
    young: ["٦٠ دقيقة يوميًا", "٣ مرات أسبوعيًا", "ناتج أسبوعي واحد", "حفظ ٢٠ مصطلحًا", "٣ تطبيقات عملية", "جلسة عرض واحدة"],
    adult: ["٣٠–٦٠ دقيقة يوميًا", "مرة أسبوعيًا", "مرة شهريًا", "٤ مرات سنويًا", "جلسة عميقة يومية", "مؤشر رضا أسبوعي"],
    mature: ["٢٠–٣٠ دقيقة", "٣ مرات أسبوعيًا", "مرة أسبوعيًا", "مرة شهريًا", "١ لقاء عائلي", "٢ مكالمات أصدقاء"],
    senior: ["١٠–٢٠ دقيقة", "مرتين يوميًا", "٣ مرات أسبوعيًا", "مرة يوميًا", "1000–2000 خطوة", "جلسة استرخاء"],
    elder: ["١٠ دقائق", "مرة يوميًا", "مرتين أسبوعيًا", "كل مساء", "٢ مكالمات أسبوعية", "٣ صور قديمة"],
  };

  const arr: ((c: MsgCtx) => string)[] = [];
  arr.push(({ yN }: MsgCtx) => `عام ${yN} — ${focus}.`);
  CLOSERS[stage].forEach((cl) => arr.push(({ yN }: MsgCtx) => `في عام ${yN} — ${focus}. ${cl()}`));
  HINTS[stage].forEach((hn) => arr.push(({ yN }: MsgCtx) => `عام ${yN} — ${focus}. ${hn()}`));
  SCHEDULES[stage].forEach((sc) => arr.push(({ yN }: MsgCtx) => `في عام ${yN} — ${focus}. ${sc}.`));
  ACTIONS[stage].forEach((ac) => arr.push(({ yN }: MsgCtx) => `عام ${yN} — ${focus}. ${ac}.`));
  METRICS[stage].forEach((mt) => arr.push(({ yN }: MsgCtx) => `في عام ${yN} — ${focus}. ${mt}.`));
  return arr;
}

export function getAgeMessages(age: AgeData, opts?: { isFriend?: boolean; name?: string }): AgeMessage {
  const y = age.years;
  const m = age.months;
  const d = age.days;
  const days = formatNumber(age.totalDays);
  const until = formatNumber(age.nextBirthday.daysUntil);

  let tone: AgeTone;
  if (y === 0 && age.totalDays < 60) tone = "newborn";
  else if (y === 0 && age.totalDays < 365) tone = "infant";
  else if (y >= 1 && y < 5) tone = "toddler";
  else if (y < 13) tone = "kid";
  else if (y < 18) tone = "teen";
  else if (y < 30) tone = "young";
  else if (y < 45) tone = "adult";
  else if (y < 60) tone = "mature";
  else if (y < 75) tone = "senior";
  else tone = "elder";

  const isFriend = !!opts?.isFriend;
  const target = isFriend && opts?.name ? opts.name : "أنت";

  let title = "رسالة لعُمرك";
  if (isFriend && opts?.name) title = `رسالة لـ ${opts.name}`;

  let lines: string[] = [];
  switch (tone) {
    case "newborn":
      lines = [
        `إجمالي الأيام حتى الآن: ${days}. هذه البدايات الأولى مليئة بالنمو السريع.`,
        `روتين هادئ ونوم كافٍ ورعاية لطيفة هي كل ما يلزم الآن.`,
        `عيد الميلاد القادم بعد ${until} يوم — الأيام تمضي بخفّة.`,
      ];
      break;
    case "infant":
      lines = [
        `أشهر جميلة من الاكتشاف المبكّر والنمو.`,
        `الغذاء الجيد والنوم المنتظم ومتابعة الطبيب مفاتيح رائعة.`,
        `العيد القادم بعد ${until} يوم — سرعان ما تكبر!`,
      ];
      break;
    case "toddler":
      lines = [
        `اللعب المنظم والقصص القصيرة ينمّيان الخيال واللغة.`,
        `نشاط حركي لطيف يوميًا يساعد على التوازن والطاقة.`,
        `العيد القادم بعد ${until} يوم — وقت للمرح مع العائلة!`,
      ];
      break;
    case "kid":
      lines = [
        `تعلم ممتع كل يوم — قراءة بسيطة وألعاب ذهنية.`,
        `نشاط رياضي خفيف يبني عادة صحية تدوم.`,
        `العيد القادم بعد ${until} يوم — هدف صغير لكل أسبوع.`,
      ];
      break;
    case "teen":
      lines = [
        `مرحلة استكشاف وصناعة العادات.`,
        `قسّم أهدافك الصغيرة على أسابيع لتنجح بسهولة.`,
        `العيد القادم بعد ${until} يوم — احتفل بإنجاز جديد!`,
      ];
      break;
    case "young":
      lines = [
        `بناء المهارات الآن يغيّر السنوات القادمة.`,
        `تحسين عادة واحدة هذا الشهر خطوة عظيمة.`,
        `العيد القادم بعد ${until} يوم — خطّط لشيء يلهمك.`,
      ];
      break;
    case "adult":
      lines = [
        `التوازن بين العمل والحياة يساوي جودة يومية أفضل.`,
        `فحص سنوي وخطّة رُبع سنوية لأهداف واضحة.`,
        `العيد القادم بعد ${until} يوم — راحة مستحقّة!`,
      ];
      break;
    case "mature":
      lines = [
        `خبرتك رصيدك الأقوى — شاركها مع من حولك.`,
        `حركة يومية 30 دقيقة وفحوصات أساسية بانتظام.`,
        `العيد القادم بعد ${until} يوم — لحظات عائلية دافئة.`,
      ];
      break;
    case "senior":
      lines = [
        `نشاط لطيف ومجتمع داعم يبقيانك في أفضل حال.`,
        `ذكرياتك كنز — دوّنها أو شاركها.`,
        `العيد القادم بعد ${until} يوم — احتفال بسيط يكفي.`,
      ];
      break;
    case "elder":
      lines = [
        `الراحة والبهجة أولويّة.`,
        `مَشْيٌ خفيف ولقاءات عائلية تمنح طاقة جميلة.`,
        `العيد القادم بعد ${until} يوم — دام الفرح والصحّة.`,
      ];
      break;
  }

  return { tone, title, lines };
}

// ---------------- One-line message API ----------------

const TONE_BANK: Record<AgeTone, ((ctx: MsgCtx) => string)[]> = {
  newborn: [
    ({ days }) => `اليوم ${days} من عمرك — الراحة، النوم، والرعاية اللطيفة هي الأولوية الآن.`,
    ({ days }) => `اليوم ${days} — نمو سريع يحتاج هدوءًا وروتينًا بسيطًا.`,
  ],
  infant: [
    ({ mN, dN }) => `عمر ${mN} شهرًا و${dN} يومًا — نوم منتظم وتغذية متوازنة يدعمان نموك.`,
    ({ mN }) => `عمر ${mN} شهرًا — المتابعة الدورية والنوم الجيد يصنعان فرقًا كبيرًا.`,
  ],
  toddler: [
    ({ yN }) => `في عامك الـ ${yN} — اللعب المنظم والقصص يبنيان اللغة والخيال.`,
    ({ yN }) => `عام ${yN} — نشاط حركي لطيف يوميًا يحسن التوازن والطاقة.`,
  ],
  kid: [
    ({ yN }) => `في عامك الـ ${yN} — قراءة قصيرة يوميًا ونشاط خفيف يبنيان عادة قوية.`,
    ({ yN }) => `عام ${yN} — هدف أسبوعي صغير يراكم إنجازات كبيرة.`,
  ],
  teen: [
    ({ yN }) => `في عامك الـ ${yN} — عادات أسبوعية بسيطة تصنع نتائج كبيرة.`,
    ({ yN }) => `عام ${yN} — قسّم أهدافك على أسابيع لتلتزم بسهولة.`,
  ],
  young: [
    ({ yN }) => `في عامك الـ ${yN} — مهارة واحدة هذا الشهر ترفع فرصك كثيرًا.`,
    ({ yN }) => `عام ${yN} — استثمر ساعة يوميًا في مهارة مركِّزة.`,
  ],
  adult: [
    ({ yN }) => `في عامك الـ ${yN} — توازن العمل والحياة يحسّن جودة يومك.`,
    ({ yN }) => `عام ${yN} — خطّة رُبع سنوية وفحص سنوي يوفّران وضوحًا وطمأنينة.`,
  ],
  mature: [
    ({ yN }) => `في عامك الـ ${yN} — شارك خبرتك وداوم على حركة يومية وفحوصات أساسية.`,
    ({ yN }) => `عام ${yN} — علاقات داعمة ونشاط معتدل يصنعان صحة أفضل.`,
  ],
  senior: [
    ({ yN }) => `في عامك الـ ${yN} — نشاط لطيف وروابط اجتماعية ينعشان يومك.`,
    ({ yN }) => `عام ${yN} — نمط نوم منتظم ومشي خفيف يحافظان على العافية.`,
  ],
  elder: [
    ({ yN }) => `في عامك الـ ${yN} — راحة وبهجة ولمّ شمل تصنع أثرًا جميلًا.`,
    ({ yN }) => `عام ${yN} — خفِّف الإيقاع واستمتع باللحظات القريبة.`,
  ],
};

function toneFor(age: AgeData): AgeTone {
  const y = age.years;
  if (y === 0 && age.totalDays < 60) return "newborn";
  if (y === 0 && age.totalDays < 365) return "infant";
  if (y >= 1 && y < 5) return "toddler";
  if (y < 13) return "kid";
  if (y < 18) return "teen";
  if (y < 30) return "young";
  if (y < 45) return "adult";
  if (y < 60) return "mature";
  if (y < 75) return "senior";
  return "elder";
}

function hashString(s: string): number {
  let h = 0;
  for (let i = 0; i < s.length; i++) {
    h = Math.imul(31, h) + s.charCodeAt(i) | 0;
  }
  return h >>> 0;
}

export function getAgeMessageLine(
  age: AgeData,
  opts?: { random?: boolean; seed?: string }
): { tone: AgeTone; text: string; variant: number } {
  const t = toneFor(age);
  const YEAR_BANK: Record<number, ((ctx: MsgCtx) => string)[]> = {
    0: [
      ({ m, d, mN, dN }: MsgCtx) => (
        m > 0
          ? `عمر ${mN} شهرًا و${dN} يومًا — الروتين الهادئ والنوم الجيد هما الأهم الآن.`
          : (d > 0
              ? `عمر ${dN} يومًا — الروتين الهادئ والنوم الجيد هما الأهم الآن.`
              : `اليوم الأول — الروتين الهادئ والنوم الجيد هما الأهم الآن.`)
      ),
      ({ m, mN }: MsgCtx) => (
        m > 0
          ? `عمر ${mN} شهرًا — متابعة النمو والتطعيمات تعطي طمأنينة.`
          : `أيامك الأولى — متابعة النمو والتطعيمات تعطي طمأنينة.`
      ),
    ],
    1: [
      ({ y }: MsgCtx) => `عام ${y} الأول — اللعب الآمن والقصص القصيرة يبنيان اللغة والفضول.`,
      (_: MsgCtx) => `عامك الأول — صور وذكريات كثيرة، وتعلّم بالمحاكاة يوميًا.`,
    ],
    2: [
      (_: MsgCtx) => `السنتان الأولى — روتين بسيط ونشاط لطيف يريح الجميع.`,
      (_: MsgCtx) => `وقت مثالي لتكوين عادات نوم وغذاء مستقرة.`,
    ],
    3: [
      (_: MsgCtx) => `عمر 3 سنوات — قصص ومكعبات وتعابير جديدة كل أسبوع.`,
      (_: MsgCtx) => `نشاط حركي يومي قصير يدعم التوازن والتركيز.`,
    ],
    4: [
      (_: MsgCtx) => `عمر 4 سنوات — ألعاب تخيّل وتعليم مبسّط بألوان وصور.`,
      (_: MsgCtx) => `تعزيز الاستقلال اللطيف يصنع ثقة مبكرة.`,
    ],
    5: [
      (_: MsgCtx) => `عمر 5 سنوات — قراءة مشتركة قصيرة تصنع حبًا للمعرفة.`,
      (_: MsgCtx) => `نشاط بدني خفيف يوميًا يرفع المزاج ويقوّي العادة.`,
    ],
    10: [
      (_: MsgCtx) => `عمر 10 — هدف أسبوعي صغير يحفّز الاستمرارية.`,
      (_: MsgCtx) => `قراءة 10 دقائق يوميًا تغيّر الكثير على المدى البعيد.`,
    ],
    12: [
      (_: MsgCtx) => `عمر 12 — تهيئة لطيفة للمراهقة بعادات نوم ودراسة واضحة.`,
      (_: MsgCtx) => `أنشطة جماعية آمنة تبني مهارات اجتماعية.`,
    ],
    13: [
      (_: MsgCtx) => `عمر 13 — بداية مراهقة واعية تحتاج حدودًا واضحة وعادات أسبوعية.`,
      (_: MsgCtx) => `قسّم الأهداف إلى أسابيع لتسهّل الالتزام.`,
    ],
    15: [
      (_: MsgCtx) => `عمر 15 — مهارة قابلة للنمو تمنحك ثقةً وتقدّمًا.`,
      (_: MsgCtx) => `ساعة مركَّزة يوميًا في هواية أو مهارة تصنع فارقًا.`,
    ],
    16: [
      (_: MsgCtx) => `عمر 16 — تنظيم الوقت يضاعف نتائجك الدراسية والحياتية.`,
      (_: MsgCtx) => `تجارب صغيرة آمنة توسّع آفاقك.`,
    ],
    18: [
      (_: MsgCtx) => `عمر 18 — قرارات واعية تبني مسارك القادم.`,
      (_: MsgCtx) => `مهارة عملية + عادة صحية = انطلاقة موفّقة.`,
    ],
    20: [
      (_: MsgCtx) => `عمر 20 — استثمر ساعة يوميًا في مهارة سوقية.`,
      (_: MsgCtx) => `شبكة علاقات محترمة تفتح أبوابًا كثيرة.`,
    ],
    25: [
      (_: MsgCtx) => `عمر 25 — وضوح الأهداف ربع السنوي يمنح تركيزًا عاليًا.`,
      (_: MsgCtx) => `موازنة صحية بين العمل والراحة تمنع الإرهاق.`,
    ],
    30: [
      (_: MsgCtx) => `عمر 30 — صيانة العادات أهم من زيادتها.`,
      (_: MsgCtx) => `فحص سنوي وخطة مالية بسيطة يوفّران طمأنينة.`,
    ],
    35: [
      (_: MsgCtx) => `عمر 35 — راجع الاتجاه: ما الذي يستحق الاستمرار؟`,
      (_: MsgCtx) => `عادات نوم ورياضة ثابتة تمنح جودة يومية.`,
    ],
    40: [
      (_: MsgCtx) => `عمر 40 — اتزان أولويات يساوي راحة أعمق.`,
      (_: MsgCtx) => `مراجعة صحية منتظمة واستثمار في العلاقات القريبة.`,
    ],
    45: [
      (_: MsgCtx) => `عمر 45 — خبرتك قيمة: شاركها بذكاء.`,
      (_: MsgCtx) => `نشاط معتدل وفحوصات أساسية بانتظام.`,
    ],
    50: [
      (_: MsgCtx) => `عمر 50 — وتيرة أهدأ واهتمام بالصحة النوعية.`,
      (_: MsgCtx) => `وقت للعائلة والهوايات يعيد التوازن.`,
    ],
    55: [
      (_: MsgCtx) => `عمر 55 — علاقات دافئة ونشاط منتظم ينعشان اليوم.`,
      (_: MsgCtx) => `خطوات خفيفة يوميًا وتغذية واعية.`,
    ],
    60: [
      (_: MsgCtx) => `عمر 60 — نمط حياة لطيف وروابط اجتماعية داعمة.`,
      (_: MsgCtx) => `متابعة طبية روتينية وراحة كافية.`,
    ],
    65: [
      (_: MsgCtx) => `عمر 65 — حفاظ على الحركة والبهجة بجرعات يومية.`,
      (_: MsgCtx) => `أنشطة اجتماعية وتواصل عائلي يرفعان المعنويات.`,
    ],
    70: [
      (_: MsgCtx) => `عمر 70 — بساطة اليوم وجودة النوم أولويات.`,
      (_: MsgCtx) => `مشي لطيف ولقاءات قريبة تمنح طاقة جميلة.`,
    ],
    75: [
      (_: MsgCtx) => `عمر 75 — خفّف الإيقاع واستمتع بالصحبة والذكريات.`,
      (_: MsgCtx) => `رعاية ذاتية رحيمة وتواصل دافئ.`,
    ],
    80: [
      (_: MsgCtx) => `عمر 80 — راحة وبهجة ولمّ شمل يكفيان.`,
      (_: MsgCtx) => `حافظ على نشاط بسيط وساعات نوم مستقرة.`,
    ],
  };
  const perYear = YEAR_BANK[age.years];
  const combined = [
    ...buildAgeMonthBank(age),
    ...(perYear ?? []),
    ...curatedYearBank(age.years),
    ...buildYearBank(age.years),
    ...TONE_BANK[t],
  ];
  const bank = combined;
  const seed = opts?.seed ?? `${age.birthDate.toISOString()}|${age.years}|${t}`;
  const idx = bank.length
    ? (opts?.random ? (hashString((opts?.seed ?? "") + String(Math.random())) % bank.length) : (hashString(seed) % bank.length))
    : 0;
  const ctx: MsgCtx = {
    y: age.years,
    m: age.months,
    d: age.days,
    yN: formatNumber(age.years),
    mN: formatNumber(age.months),
    dN: formatNumber(age.days),
    days: formatNumber(age.totalDays),
    until: formatNumber(age.nextBirthday.daysUntil),
  };
  const text = opts?.random
    ? (bank.length && Math.random() < 0.75 ? bank[idx](ctx) : composeToneMessage(t, ctx, bank[idx]))
    : (bank.length ? bank[idx](ctx) : `في عامك الـ ${ctx.yN} — اجعل يومك أبسط وأكثر اتزانًا.`);
  return { tone: t, text, variant: idx };
}

function randPick<T>(arr: T[]): T { return arr[Math.floor(Math.random() * arr.length)]; }

function composeToneMessage(tone: AgeTone, ctx: MsgCtx, fallback?: (c: MsgCtx) => string): string {
  const commonClose = [
    () => `خطوة صغيرة اليوم تصنع فرقًا كبيرًا.`,
    () => `ابْنِ عاداتٍ بسيطة ومتسقة.`,
    () => `وازن بين الجهد والراحة.`,
  ];
  const toneParts: Record<AgeTone, { open: ((c: MsgCtx) => string)[]; hint: ((c: MsgCtx) => string)[]; close?: ((c: MsgCtx) => string)[] }> = {
    newborn: {
      open: [
        ({ days }) => `اليوم ${days} من عمرك` ,
        ({ days }) => `بداياتك الأولى — اليوم ${days}`,
      ],
      hint: [
        () => `الراحة والنوم والرعاية اللطيفة هي الأولوية الآن`,
        () => `روتين هادئ يُساعِد على نمو مطمئن`,
      ],
      close: [
        () => `النوم الكافي والهدوء أهم ما يلزم الآن.`,
        () => `وتيرة لطيفة تكفي في هذه المرحلة المبكرة.`,
        () => `كل يوم يمر بنمو مطمئن ورعاية دافئة.`,
      ],
    },
    infant: {
      open: [
        ({ mN, dN }) => `عمر ${mN} شهرًا و${dN} يومًا` ,
        ({ mN }) => `عمر ${mN} شهرًا` ,
      ],
      hint: [
        () => `نوم منتظم وتغذية متوازنة يدعمان نموك`,
        () => `متابعة دورية تمنح طمأنينةً وتقدمًا صحّيًا`,
      ],
      close: [
        () => `الهدوء والانتظام يصنعان فرقًا كبيرًا الآن.`,
        () => `الراحة والرعاية اللطيفة تكفيان في هذه المرحلة.`,
        () => `روتين بسيط ومستقر هو الأنسب حاليًا.`,
      ],
    },
    toddler: {
      open: [ ({ yN }) => `في عامك الـ ${yN}` ],
      hint: [
        () => `اللعب المنظم والقصص يبنيان اللغة والخيال`,
        () => `نشاط حركي لطيف يرفع الطاقة والتوازن`,
      ],
      close: commonClose,
    },
    kid: {
      open: [ ({ yN }) => `في عامك الـ ${yN}` ],
      hint: [
        () => `قراءة قصيرة يوميًا ونشاط خفيف يبنيان عادة قوية`,
        () => `هدف أسبوعي صغير يراكم إنجازات كبيرة`,
      ],
      close: commonClose,
    },
    teen: {
      open: [ ({ yN }) => `في عامك الـ ${yN}` ],
      hint: [
        () => `قسّم أهدافك على أسابيع لتلتزم بسهولة`,
        () => `عادات أسبوعية بسيطة تصنع نتائج كبيرة`,
      ],
      close: commonClose,
    },
    young: {
      open: [ ({ yN }) => `في عامك الـ ${yN}` ],
      hint: [
        () => `ساعة يومية لمهارة مركِّزة ترفع فرصك كثيرًا`,
        () => `مهارة واحدة هذا الشهر تُحدث فارقًا`,
      ],
      close: commonClose,
    },
    adult: {
      open: [ ({ yN }) => `في عامك الـ ${yN}` ],
      hint: [
        () => `توازن العمل والحياة يحسّن جودة يومك`,
        () => `خطة ربع سنوية وفحص سنوي يوفّران وضوحًا وطمأنينة`,
      ],
      close: commonClose,
    },
    mature: {
      open: [ ({ yN }) => `في عامك الـ ${yN}` ],
      hint: [
        () => `شارك خبرتك وداوم على حركة يومية وفحوصات أساسية`,
        () => `علاقات داعمة ونشاط معتدل يصنعان صحة أفضل`,
      ],
      close: commonClose,
    },
    senior: {
      open: [ ({ yN }) => `في عامك الـ ${yN}` ],
      hint: [
        () => `نشاط لطيف وروابط اجتماعية ينعشان يومك`,
        () => `نمط نوم منتظم ومشي خفيف يحافظان على العافية`,
      ],
      close: commonClose,
    },
    elder: {
      open: [ ({ yN }) => `في عامك الـ ${yN}` ],
      hint: [
        () => `خفِّف الإيقاع واستمتع باللحظات القريبة`,
        () => `راحة وبهجة ولمّ شمل تصنع أثرًا جميلًا`,
      ],
      close: commonClose,
    },
  };

  const p = toneParts[tone] ?? toneParts.adult;
  try {
    const msg = `${randPick(p.open)(ctx)} — ${randPick(p.hint)(ctx)}. ${randPick(p.close!)(ctx)}`;
    return msg;
  } catch {
    return fallback ? fallback(ctx) : `في عامك الـ ${ctx.yN} — اجعل يومك أبسط وأكثر اتزانًا.`;
  }
}
