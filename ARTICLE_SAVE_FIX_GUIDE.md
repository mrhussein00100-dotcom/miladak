# دليل إصلاح مشكلة حفظ المقالات مع الصور

## المشكلة

كانت هناك مشكلة في حفظ المقالات عند استبدال الصور في مواقع معينة. نفس الصورة تعمل في مكان ولا تعمل في مكان آخر.

## الحل المطبق

### 1. تحسين تنظيف URLs الصور

- تم تحسين دالة `sanitizeImageUrls` لتكون أكثر أماناً
- إزالة أحرف التحكم فقط بدلاً من جميع الأحرف الخاصة
- إضافة معالجة أفضل للأخطاء

### 2. تحسين معالجة الصور في التنسيق

- تم تحسين دالة `formatContent` لتجنب تعديل الصور الموجودة داخل `<figure>` أو `<div>` منسق
- إضافة فحص السياق قبل تعديل الصور
- معالجة أفضل للأخطاء

### 3. إضافة التحقق من صحة المحتوى

- دالة `validateImageHtml` للتحقق من الصور المكررة
- كشف الصور المكسورة في السياق
- إصلاح تلقائي للمشاكل البسيطة

### 4. تحسين عملية الحفظ

- تطبيق تنظيف أساسي فقط عند الحفظ
- تجنب التنسيق التلقائي الذي قد يكسر HTML
- إضافة سجلات مفصلة للتشخيص

### 5. أدوات التشخيص

- سكريبت `debug-article-save.js` لاختبار المحتوى محلياً
- API `/api/debug-content` لتحليل المحتوى
- مكون `ContentDebugger` في صفحة تعديل المقال

## كيفية الاستخدام

### 1. اختبار المحتوى قبل الحفظ

في صفحة تعديل المقال، ستجد قسم "تشخيص المحتوى":

- اضغط على "تحليل المحتوى" لفحص المقال
- سيظهر لك تقرير مفصل عن الصور والمشاكل المحتملة
- إذا وجدت مشاكل، ستظهر لك التفاصيل والحلول

### 2. استخدام السكريبت المحلي

```bash
node debug-article-save.js
```

### 3. نصائح لتجنب المشاكل

- تجنب نسخ ولصق نفس الصورة عدة مرات في مكان قريب
- استخدم زر "تنسيق المحتوى" بحذر
- اختبر المحتوى قبل الحفظ باستخدام أداة التشخيص

## الملفات المعدلة

- `miladak_v2/app/api/admin/articles/[id]/route.ts` - تحسين API الحفظ
- `miladak_v2/lib/utils/contentFormatter.ts` - تحسين تنسيق المحتوى
- `miladak_v2/app/admin/articles/[id]/page.tsx` - تحسين صفحة التعديل
- `miladak_v2/components/admin/ContentDebugger.tsx` - أداة التشخيص الجديدة
- `miladak_v2/app/api/debug-content/route.ts` - API التشخيص
- `miladak_v2/debug-article-save.js` - سكريبت التشخيص المحلي

## اختبار الإصلاح

1. افتح مقال للتعديل
2. استخدم أداة "تشخيص المحتوى"
3. جرب استبدال صورة في مواقع مختلفة
4. احفظ المقال وتأكد من عدم ظهور أخطاء

إذا استمرت المشكلة، استخدم أداة التشخيص لتحديد السبب الدقيق.
